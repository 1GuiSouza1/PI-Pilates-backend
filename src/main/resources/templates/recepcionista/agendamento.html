<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Aulas</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/home-recepcionista.css}">
    <link rel="stylesheet" th:href="@{/css/recepcionista/agendamento.css}">
</head>
<body>
    <header>
        <div class="top-bar">
            <img th:src="@{/images/lotus.png}" alt="Logo Pilates" class="logo" />
            <a class="logo-name" th:href="@{/web/recepcionista/home}">Pilates</a>
        </div>
        <div class="profile-circle"></div>
    </header>

    <main>
        <div th:if="${mensagem}" th:classappend="${mensagemTipo == 'sucesso'} ? 'alerta-sucesso' : 'alerta-erro'">
            <span th:text="${mensagem}"></span>
        </div>
        <h2>Agenda de Aulas</h2>
        <button class="btn-agendar" onclick="abrirModalAgendamento()">Agendar</button>

        <div id="modalAgendamento" class="modal-detalhes">
            <div class="modal-conteudo">
                <span class="fechar" onclick="fecharModalAgendamento()">&times;</span>
                <h2>Agendamento</h2>
                <form id="formAgendamento" method="post" action="/web/recepcionista/agendamento/salvar">
                    <div class="campo-form">
                        <label for="dataAula"><strong>Data:</strong></label>
                        <input type="date" id="dataAula" name="data" required>
                    </div>
                    <div class="campo-form">
                        <label for="horarioAula"><strong>Horário:</strong></label>
                        <input type="time" id="horarioAula" name="horario" required>
                    </div>
                    <!-- <div class="campo-form">
                        <label for="modalidadeAula"><strong>Modalidade:</strong></label>
                        <input type="text" id="modalidadeAula" name="modalidade">
                    </div> -->
                    <!-- <div class="campo-form">
                        <label for="instrutorAula"><strong>Instrutor(a):</strong></label>
                        <input type="text" id="instrutorAula" name="idInstrutor">
                    </div> -->
                    <div class="campo-form">
                        <label for="estudioAula"><strong>Estúdio:</strong></label>
                        <select id="estudioAula" name="idStudio" required>
                            <option value="" disabled selected>Selecione o estúdio</option>
                            <option th:each="estudio : ${estudios}" th:value="${estudio.id}" th:text="${estudio.nome}"></option>
                        </select>
                    </div>
                    <div class="campo-form">
                        <label for="alunoAula"><strong>Aluno:</strong></label>
                        <select id="alunoAula" name="alunos" required>
                            <option value="" disabled selected>Selecione o aluno</option>
                            <option th:each="aluno : ${alunos}" th:value="${aluno.id}" th:text="${aluno.nome}"></option>
                        </select>
                    </div>
                    <button type="submit" class="btn-agendar-enviar">Agendar</button>
                </form>
            </div>
        </div>

        <div class="aulas-marcadas aulas-marcadas-scroll">
            <ul>
                <li th:each="aula : ${aulas}">
                    <div class="aula-card">
                        <div class="aula-info-col">
                            <span>
                                <strong th:text="${aula.data != null ? #temporals.format(aula.data, 'dd/MM/yyyy') : ''}"></strong>
                                <strong th:text="${aula.horario != null ? #temporals.format(aula.horario, 'HH:mm') : ''}" style="margin-left: 12px;"></strong>
                                <span style="margin-left: 18px;">
                                    <strong>Alunos:</strong>
                                    <strong><span th:text="${#lists.isEmpty(aula.alunos) ? 'Nenhum' : #strings.listJoin(aula.alunos, ', ')}"></span></strong>
                                </span>
                                <span style="margin-left: 18px;">
                                    <strong>Estúdio:</strong>
                                    <strong><span th:text="${aula.estudioNome != null ? aula.estudioNome : 'Não informado'}"></span></strong>
                                </span>
                            </span>
                        </div>
                        <div class="aula-botoes">
                            <form th:action="@{/web/recepcionista/agendamento/deletar/{id}(id=${aula.id})}" method="post" style="display:inline;">
                                <button type="submit" onclick="return confirm('Tem certeza que deseja cancelar esta aula?')">Cancelar</button>
                            </form>
                            <button type="button"
                                th:attr="onclick=|abrirModalPresenca('${aula.id}', '${aula.alunos != null ? #strings.arrayJoin(aula.alunos, ',') : ''}', '', '${aula.presentes != null ? #strings.arrayJoin(aula.presentes, ',') : ''}')|"
                                th:text="(${aula.status == null or #strings.isEmpty(aula.status) or aula.status == 'Não informado' or aula.status == 'Pendente'}) ? 'Marcar Presença'
                                    : (${aula.status.equalsIgnoreCase('Presente')} ? 'Revisar Presença'
                                    : (${aula.status.equalsIgnoreCase('Ausente')} ? 'Revisar Ausência' : 'Marcar Presença'))">
                                Marcar Presença
                            </button>
                        </div>
                    </div>
                </li>
                <li th:if="${#lists.isEmpty(aulas)}">Nenhuma aula marcada.</li>
            </ul>
            <div id="modalPresenca" class="modal-detalhes" style="display:none;">
                <div class="modal-conteudo">
                    <span class="fechar" onclick="fecharModalPresenca()">&times;</span>
                    <form id="formPresenca" onsubmit="enviarPresenca(event)">
                        <div class="bloco-presenca">
                            <div class="titulo-presenca"><strong>Nome da Aula:</strong></div>
                            <div id="nomeAula"></div>
                        </div>
                        <div class="bloco-presenca">
                            <div class="titulo-presenca"><strong>Presença:</strong></div>
                            <div id="listaAlunosPresenca"></div>
                        </div>
                        <div class="bloco-presenca">
                            <div class="titulo-presenca"><strong>Observações:</strong></div>
                            <div id="observacaoAula" style="min-height:32px; color:#333;"></div>
                        </div>
                        <button type="submit" class="btn-agendar-enviar">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        function updateGradient() {
            const bloco = document.querySelector('.aulas-marcadas-scroll');
            if (!bloco) return;
            if (bloco.scrollTop === 0 && bloco.scrollHeight > bloco.clientHeight) {
                bloco.classList.add('show-gradient');
            } else {
                bloco.classList.remove('show-gradient');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const bloco = document.querySelector('.aulas-marcadas-scroll');
            if (bloco) {
                updateGradient();
                bloco.addEventListener('scroll', updateGradient);
                window.addEventListener('resize', updateGradient);
            }
            const alerta = document.querySelector('.alerta-sucesso, .alerta-erro');
            if (alerta) {
                setTimeout(() => {
                    alerta.style.display = 'none';
                }, 2000);
            }
        });

        function abrirModalAgendamento() {
            document.getElementById('modalAgendamento').style.display = 'flex';
        }
        function fecharModalAgendamento() {
            document.getElementById('modalAgendamento').style.display = 'none';
        }
        window.onclick = function(event) {
            const modalAgendamento = document.getElementById('modalAgendamento');
            if (event.target === modalAgendamento) fecharModalAgendamento();
        }
    </script>
    <script>
        let presencaAulaId = null;

        function abrirModalPresenca(aulaId, alunosStr, observacao = '', presentesStr = '') {
        presencaAulaId = aulaId;
        const modal = document.getElementById('modalPresenca');
        const nomeDiv = document.getElementById('nomeAula');
        nomeDiv.textContent = '';
        const listaDiv = document.getElementById('listaAlunosPresenca');
        const obsDiv = document.getElementById('observacaoAula');
        listaDiv.innerHTML = '';

        const alunos = alunosStr ? alunosStr.split(',') : [];
        const presentes = presentesStr ? presentesStr.split(',') : [];

        alunos.forEach((nome, idx) => {
            const id = `aluno-presenca-${idx}`;
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.marginBottom = '8px';
            const checked = presentes.includes(nome.trim()) ? 'checked' : '';
            div.innerHTML = `
                <input type="checkbox" id="${id}" name="presenca" value="${nome.trim()}" style="margin-right:8px;" ${checked}>
                <label for="${id}">${nome.trim()}</label>
            `;
            listaDiv.appendChild(div);
        });

        obsDiv.textContent = observacao || 'Sem observações.';

        modal.style.display = 'flex';
    }

        function enviarPresenca(event) {
            event.preventDefault();

            const checkboxes = document.querySelectorAll('#listaAlunosPresenca input[type="checkbox"]:checked');
            const alunosPresentes = Array.from(checkboxes).map(cb => cb.value);

            fetch(`/web/recepcionista/agendamento/presenca/${presencaAulaId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ presentes: alunosPresentes })
            })
            .then(response => {
                if (response.ok) {
                    alert('Presenças salvas com sucesso!');
                    fecharModalPresenca();
                    window.location.reload();
                } else {
                    alert('Erro ao salvar presenças.');
                }
            })
            .catch(() => alert('Erro ao salvar presenças.'));
        }

        function fecharModalPresenca() {
            document.getElementById('modalPresenca').style.display = 'none';
        }

        window.onclick = function(event) {
            const modalPresenca = document.getElementById('modalPresenca');
            if (event.target === modalPresenca) fecharModalPresenca();

            const modalAgendamento = document.getElementById('modalAgendamento');
            if (event.target === modalAgendamento) fecharModalAgendamento();
        }
    </script>
</body>
</html>